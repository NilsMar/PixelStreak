<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelStreak - Login</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#14b8a6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PixelStreak">
    <link rel="apple-touch-icon" href="icons/icon.svg">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>PixelStreak</h1>
                <p id="authSubtitle">Sign in to track your goals</p>
            </div>

            <div class="error-message" id="errorMessage"></div>

            <form class="auth-form" id="authForm">
                <div class="form-group" id="emailGroup">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="your@email.com">
                </div>

                <div class="form-group" id="passwordGroup">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="••••••••" minlength="6">
                </div>

                <div class="form-group" id="newPasswordGroup" style="display:none">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" placeholder="••••••••" minlength="6">
                </div>

                <button type="submit" id="submitBtn">Sign In</button>
            </form>

            <div class="auth-toggle">
                <span id="toggleText">Don't have an account?</span>
                <button type="button" id="toggleMode">Sign up</button>
            </div>
            <div class="auth-toggle" id="forgotPasswordRow">
                <button type="button" id="forgotPasswordBtn">Forgot password?</button>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import { signIn, signUp, getCurrentUser, sendPasswordReset, updatePassword, supabase } from './js/auth.js';

        // DOM Elements
        const authForm = document.getElementById('authForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const newPasswordInput = document.getElementById('newPassword');
        const emailGroup = document.getElementById('emailGroup');
        const passwordGroup = document.getElementById('passwordGroup');
        const newPasswordGroup = document.getElementById('newPasswordGroup');
        const submitBtn = document.getElementById('submitBtn');
        const errorMessage = document.getElementById('errorMessage');
        const authSubtitle = document.getElementById('authSubtitle');
        const toggleText = document.getElementById('toggleText');
        const toggleModeBtn = document.getElementById('toggleMode');
        const forgotPasswordRow = document.getElementById('forgotPasswordRow');
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');

        // Modes: 'signin' | 'signup' | 'forgot' | 'reset'
        let mode = 'signin';

        function setMode(newMode) {
            mode = newMode;
            errorMessage.classList.remove('visible');

            const show = (el) => el.style.display = '';
            const hide = (el) => el.style.display = 'none';

            emailInput.required = false;
            passwordInput.required = false;
            newPasswordInput.required = false;

            if (mode === 'signin') {
                authSubtitle.textContent = 'Sign in to track your goals';
                submitBtn.textContent = 'Sign In';
                show(emailGroup); show(passwordGroup); hide(newPasswordGroup);
                show(forgotPasswordRow);
                toggleText.textContent = "Don't have an account?";
                toggleModeBtn.textContent = 'Sign up';
                show(document.querySelector('.auth-toggle'));
                emailInput.required = true; passwordInput.required = true;
            } else if (mode === 'signup') {
                authSubtitle.textContent = 'Create your account';
                submitBtn.textContent = 'Sign Up';
                show(emailGroup); show(passwordGroup); hide(newPasswordGroup);
                hide(forgotPasswordRow);
                toggleText.textContent = 'Already have an account?';
                toggleModeBtn.textContent = 'Sign in';
                show(document.querySelector('.auth-toggle'));
                emailInput.required = true; passwordInput.required = true;
            } else if (mode === 'forgot') {
                authSubtitle.textContent = 'Reset your password';
                submitBtn.textContent = 'Send Reset Email';
                show(emailGroup); hide(passwordGroup); hide(newPasswordGroup);
                hide(forgotPasswordRow);
                toggleText.textContent = 'Back to';
                toggleModeBtn.textContent = 'Sign in';
                show(document.querySelector('.auth-toggle'));
                emailInput.required = true;
            } else if (mode === 'reset') {
                authSubtitle.textContent = 'Set your new password';
                submitBtn.textContent = 'Update Password';
                hide(emailGroup); hide(passwordGroup); show(newPasswordGroup);
                hide(forgotPasswordRow);
                hide(document.querySelector('.auth-toggle'));
                newPasswordInput.required = true;
            }
        }

        // Detect password recovery from Supabase redirect
        supabase.auth.onAuthStateChange((event) => {
            if (event === 'PASSWORD_RECOVERY') {
                setMode('reset');
            }
        });

        // Check if already logged in
        getCurrentUser().then(user => {
            if (user && mode !== 'reset') {
                window.location.href = 'app.html';
            }
        });

        // Toggle between signin / signup
        toggleModeBtn.addEventListener('click', () => {
            setMode(mode === 'signup' ? 'signin' : (mode === 'forgot' ? 'signin' : 'signup'));
        });

        // Forgot password link
        forgotPasswordBtn.addEventListener('click', () => setMode('forgot'));

        // Form submission
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessage.classList.remove('visible');
            submitBtn.disabled = true;

            try {
                if (mode === 'signin') {
                    submitBtn.textContent = 'Signing in...';
                    await signIn(emailInput.value.trim(), passwordInput.value);
                    window.location.href = 'app.html';

                } else if (mode === 'signup') {
                    submitBtn.textContent = 'Signing up...';
                    await signUp(emailInput.value.trim(), passwordInput.value);
                    showMessage('Account created! Please sign in.');
                    passwordInput.value = '';
                    setMode('signin');

                } else if (mode === 'forgot') {
                    submitBtn.textContent = 'Sending...';
                    await sendPasswordReset(emailInput.value.trim());
                    showMessage('Check your email for a reset link.');

                } else if (mode === 'reset') {
                    const newPw = newPasswordInput.value;
                    if (newPw.length < 6) { showError('Password must be at least 6 characters'); return; }
                    submitBtn.textContent = 'Updating...';
                    await updatePassword(newPw);
                    window.location.href = 'app.html';
                }
            } catch (error) {
                console.error('Auth error:', error);
                let msg = 'An error occurred. Please try again.';
                if (error.message.includes('Invalid login credentials')) msg = 'Invalid email or password';
                else if (error.message.includes('Email not confirmed')) msg = 'Please confirm your email address';
                else if (error.message.includes('User already registered')) msg = 'An account with this email already exists';
                else if (error.message) msg = error.message;
                showError(msg);
            } finally {
                submitBtn.disabled = false;
                const labels = { signin: 'Sign In', signup: 'Sign Up', forgot: 'Send Reset Email', reset: 'Update Password' };
                submitBtn.textContent = labels[mode];
            }
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.background = 'rgba(239, 68, 68, 0.1)';
            errorMessage.style.borderColor = 'var(--cell-missed)';
            errorMessage.style.color = 'var(--cell-missed)';
            errorMessage.classList.add('visible');
        }

        function showMessage(message) {
            errorMessage.textContent = message;
            errorMessage.style.background = 'rgba(94, 234, 212, 0.1)';
            errorMessage.style.borderColor = 'var(--cell-completed)';
            errorMessage.style.color = 'var(--cell-completed)';
            errorMessage.classList.add('visible');
        }
    </script>
</body>
</html>
